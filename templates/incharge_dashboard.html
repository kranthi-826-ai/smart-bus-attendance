<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Incharge Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h2>Bus Incharge Dashboard</h2>
        <p>Welcome, {{ incharge_name }} | Bus: {{ bus_number }}</p>
        
        <!-- Camera Section for Face Scanning -->
        <div class="camera-section">
            <h3>Mark Attendance with Face Recognition</h3>
            
            <div class="camera-container">
                <video id="video" width="400" height="300" autoplay></video>
                <canvas id="canvas" width="400" height="300" style="display:none;"></canvas>
            </div>
            
            <div class="camera-controls">
                <button id="capture-btn" onclick="capturePhoto()">Capture & Mark Attendance</button>
                <button id="retake-btn" onclick="retakePhoto()" style="display:none;">Retake Photo</button>
            </div>
            
            <div id="result-message"></div>
        </div>

        <!-- Today's Attendance Records -->
        <div class="attendance-records">
            <h3>Today's Attendance</h3>
            <table>
                <thead>
                    <tr>
                        <th>Student Name</th>
                        <th>Roll Number</th>
                        <th>Status</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="attendance-table">
                    {% for record in attendance_records %}
                    <tr>
                        <td>{{ record.name }}</td>
                        <td>{{ record.roll_number }}</td>
                        <td>{{ record.status }}</td>
                        <td>{{ record.marked_at }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <a href="{{ url_for('logout') }}">Logout</a>
    </div>

    <script>
        // Camera access
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        
        // Access camera
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
            })
            .catch(err => {
                console.error("Error accessing camera: ", err);
                document.getElementById('result-message').innerHTML = 
                    '<div class="error">Camera access denied. Please allow camera permissions.</div>';
            });
        
        function capturePhoto() {
            // Draw video frame to canvas
            context.drawImage(video, 0, 0, 400, 300);
            
            // Convert to blob and send to server
            canvas.toBlob(blob => {
                const formData = new FormData();
                formData.append('photo', blob, 'capture.jpg');
                formData.append('bus_number', '{{ bus_number }}');
                
                // Show loading
                document.getElementById('result-message').innerHTML = 
                    '<div class="info">Processing face recognition...</div>';
                
                // Send to server for face recognition
                fetch('/mark_attendance', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('result-message').innerHTML = 
                            `<div class="success">✅ ${data.message}</div>`;
                        // Refresh attendance records
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        document.getElementById('result-message').innerHTML = 
                            `<div class="error">❌ ${data.message}</div>`;
                    }
                })
                .catch(error => {
                    document.getElementById('result-message').innerHTML = 
                        '<div class="error">Error marking attendance</div>';
                });
            }, 'image/jpeg');
        }
        
        function retakePhoto() {
            document.getElementById('capture-btn').style.display = 'block';
            document.getElementById('retake-btn').style.display = 'none';
            document.getElementById('result-message').innerHTML = '';
        }
    </script>
</body>
</html>